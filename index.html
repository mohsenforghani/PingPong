<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>پینگ‌پونگ آنلاین</title>
<style>
html,body{margin:0;padding:0;background:#000;color:#fff;overflow:hidden;font-family:tahoma;}
#gameCanvas{display:block;width:100%;height:100vh;background:#000;}
#scoreBox{position:absolute;top:10px;width:100%;text-align:center;font-size:24px;}
#statusText{position:absolute;bottom:20px;width:100%;text-align:center;font-size:16px;}
#menu{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
button{background:#222;color:#fff;border:1px solid #666;padding:10px 20px;margin:5px;font-size:18px;border-radius:8px;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="scoreBox"></div>
<div id="statusText"></div>

<div id="menu">
  <button id="waitBtn">منتظر حریف بمان</button>
  <button id="acceptBtn" style="display:none;">پذیرش بازی</button>
  <button id="declineBtn" style="display:none;">رد کردن</button>
</div>

<script>
const WS_URL = "wss://pingpong-te0t.onrender.com"; // سرور خودت را بگذار
const LOGICAL_W = 450, LOGICAL_H = 800;
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const scoreBox = document.getElementById("scoreBox");
const statusText = document.getElementById("statusText");

const menu = document.getElementById("menu");
const waitBtn = document.getElementById("waitBtn");
const acceptBtn = document.getElementById("acceptBtn");
const declineBtn = document.getElementById("declineBtn");

let ws, playerId = null, gameStarted = false, gameState = null;
let renderBall = { x: LOGICAL_W / 2, y: LOGICAL_H / 2 };
let renderPaddles = [
  { x: LOGICAL_W / 2 - 50, y: 10 },
  { x: LOGICAL_W / 2 - 50, y: LOGICAL_H - 30 }
];

// تمام‌صفحه
function resizeCanvas() {
  const ratio = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * ratio;
  canvas.height = window.innerHeight * ratio;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(ratio, ratio);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// اتصال به سرور
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => { statusText.textContent = "به سرور متصل شد"; };
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    switch(data.type) {
      case "assign":
        playerId = data.playerId;
        statusText.textContent = `شما بازیکن ${playerId + 1} هستید`;
        break;
      case "waiting_for_opponent":
        menu.style.display = "block";
        waitBtn.style.display = "none";
        acceptBtn.style.display = "none";
        declineBtn.style.display = "none";
        statusText.textContent = "در انتظار حریف...";
        break;
      case "opponent_waiting":
        statusText.textContent = "یک بازیکن منتظر است، می‌خواهی بپیوندی؟";
        menu.style.display = "block";
        waitBtn.style.display = "none";
        acceptBtn.style.display = "inline-block";
        declineBtn.style.display = "inline-block";
        break;
      case "declined":
        statusText.textContent = "حریف بازی را رد کرد";
        menu.style.display = "block";
        waitBtn.style.display = "inline-block";
        acceptBtn.style.display = "none";
        declineBtn.style.display = "none";
        break;
      case "start":
        gameStarted = true;
        menu.style.display = "none";
        statusText.textContent = "بازی شروع شد!";
        break;
      case "state":
        gameState = data.state;
        scoreBox.textContent = `${gameState.scores[0]} - ${gameState.scores[1]}`;
        break;
    }
  };
  ws.onclose = () => {
    statusText.textContent = "ارتباط قطع شد، در حال اتصال مجدد...";
    setTimeout(connectWS, 1000);
  };
}
connectWS();

// کنترل‌ها
waitBtn.onclick = () => ws.send(JSON.stringify({ type: "waitForPlayer" }));
acceptBtn.onclick = () => ws.send(JSON.stringify({ type: "acceptMatch" }));
declineBtn.onclick = () => ws.send(JSON.stringify({ type: "declineMatch" }));

// ارسال موقعیت پدل
let lastSend = 0;
function sendPaddle(x) {
  if (!gameStarted || !ws || ws.readyState !== WebSocket.OPEN) return;
  const scale = Math.min(canvas.width / LOGICAL_W, canvas.height / LOGICAL_H);
  const offsetX = (canvas.width / scale - LOGICAL_W) / 2;
  let logicalX = (x / scale) - offsetX - 50;
  logicalX = Math.max(0, Math.min(LOGICAL_W - 100, logicalX));
  const now = Date.now();
  if (now - lastSend > 50) {
    lastSend = now;
    ws.send(JSON.stringify({ type: "paddle", player: playerId, x: logicalX }));
  }
}

document.addEventListener("mousemove", e => sendPaddle(e.clientX));
document.addEventListener("touchmove", e => { e.preventDefault(); sendPaddle(e.touches[0].clientX); }, { passive:false });

// رندر بازی
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (gameState) {
    const scale = Math.min(canvas.width / LOGICAL_W, canvas.height / LOGICAL_H);
    const offsetX = (canvas.width - LOGICAL_W * scale) / 2;
    const offsetY = (canvas.height - LOGICAL_H * scale) / 2;

    // توپ
    renderBall.x += (gameState.ball.x - renderBall.x) * 0.2;
    renderBall.y += (gameState.ball.y - renderBall.y) * 0.2;
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(offsetX + renderBall.x * scale, offsetY + renderBall.y * scale, gameState.ball.radius * scale, 0, Math.PI * 2);
    ctx.fill();

    // پدل‌ها
    gameState.paddles.forEach((p, i) => {
      renderPaddles[i].x += (p.x - renderPaddles[i].x) * 0.3;
      renderPaddles[i].y = p.y;
      ctx.fillRect(offsetX + renderPaddles[i].x * scale, offsetY + renderPaddles[i].y * scale, p.w * scale, p.h * scale);
    });
  }
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
