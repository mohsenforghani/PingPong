<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>بازی آنلاین پینگ‌پونگ</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  height: 100%;
  width: 100%;
}
canvas {
  display: block;
  width: 100%;
  height: 100%;
}
button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 20px;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  background: #00ff88;
  color: black;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<button id="startBtn">در انتظار بازیکن دوم...</button>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('startBtn');

// تنظیم فول‌اسکرین
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// اتصال به WebSocket Render
const ws = new WebSocket('wss://pingpong-te0t.onrender.com');

let playerId = null;
let gameStarted = false;
let gameState = null;

// دریافت پیام‌ها از سرور
ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);

  if (data.type === 'assign') {
    playerId = data.playerId;
    btn.textContent = (playerId === 0) ? "در انتظار بازیکن دوم..." : "شروع بازی";
    btn.disabled = (playerId === 0);
  }

  if (data.type === 'start') {
    gameStarted = true;
    btn.style.display = 'none';
  }

  if (data.type === 'state') {
    gameState = data.state;
  }

  if (data.type === 'full') {
    alert("بازی پر است، لطفاً بعداً امتحان کنید!");
  }
};

// دکمه شروع
btn.onclick = () => {
  if (playerId === 1) {
    ws.send(JSON.stringify({ type: 'start' }));
  }
};

// ارسال موقعیت راکت
function sendPaddle(y) {
  if (playerId === null || !gameStarted) return;
  ws.send(JSON.stringify({ type: 'paddle', player: playerId, y }));
}

// کنترل موس
document.addEventListener('mousemove', e => {
  const y = e.clientY * (600 / canvas.height) - 50;
  sendPaddle(y);
});

// کنترل لمس
document.addEventListener('touchmove', e => {
  e.preventDefault();
  const y = e.touches[0].clientY * (600 / canvas.height) - 50;
  sendPaddle(y);
}, { passive: false });

// رسم بازی
function draw() {
  if (!gameState) return requestAnimationFrame(draw);

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const scaleX = canvas.width / 800;
  const scaleY = canvas.height / 600;

  // توپ
  const b = gameState.ball;
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(b.x * scaleX, b.y * scaleY, b.radius * scaleX, 0, Math.PI * 2);
  ctx.fill();

  // راکت‌ها
  ctx.fillStyle = "white";
  gameState.paddles.forEach(p => {
    ctx.fillRect(p.x * scaleX, p.y * scaleY, p.w * scaleX, p.h * scaleY);
  });

  // امتیاز
  ctx.font = `${24 * scaleY}px Arial`;
  ctx.textAlign = "center";
  ctx.fillText(`${gameState.scores[0]}  -  ${gameState.scores[1]}`, canvas.width / 2, 50);

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
