<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ping Pong آنلاین</title>
<style>
html, body {margin:0; padding:0; height:100%; background:#000; color:#fff; overflow:hidden; font-family:tahoma;}
#gameCanvas{display:block; width:100%; height:100vh; background:#000; touch-action:none;}
#scoreBox{position:absolute; top:10px; width:100%; text-align:center; font-size:24px;}
#statusText{position:absolute; bottom:10px; width:100%; text-align:center; font-size:16px;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="scoreBox"></div>
<div id="statusText"></div>
<script>
const WS_URL='wss://pingpong-te0t.onrender.com'; // آدرس WebSocket
const LOGICAL_W=450;
const LOGICAL_H=800;

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const scoreBox=document.getElementById('scoreBox');
const statusText=document.getElementById('statusText');

let ws=null;
let playerId=null;
let gameStarted=false;
let gameState=null;

// رندر توپ و پدل‌ها
let renderBall={x:LOGICAL_W/2, y:LOGICAL_H/2};
let renderPaddles=[
  {x:LOGICAL_W/2-50, y:10},
  {x:LOGICAL_W/2-50, y:LOGICAL_H-30}
];

// تنظیم اندازه صفحه
function resizeCanvas(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

// اتصال WebSocket
function connectWS(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{statusText.textContent='متصل شد به سرور...'; ws.send(JSON.stringify({type:'checkWaiting'}));};
  ws.onmessage=(evt)=>{
    let data;
    try{data=JSON.parse(evt.data);}catch(e){return;}
    switch(data.type){
      case 'assign':
        playerId=data.playerId;
        statusText.textContent=`شما بازیکن ${playerId} هستید`;
        break;
      case 'start':
        gameStarted=true;
        statusText.textContent='بازی شروع شد';
        break;
      case 'state':
        gameState=data.state;
        scoreBox.textContent=`${gameState.scores[0]} - ${gameState.scores[1]}`;
        break;
      case 'full':
        alert('بازی پر است');
        break;
      default: console.log('unknown',data);
    }
  };
  ws.onclose=()=>{statusText.textContent='ارتباط قطع شد'; setTimeout(connectWS,1000);};
}
connectWS();

// ارسال موقعیت پدل
function sendPaddle(clientX){
  if(!gameStarted || !ws || ws.readyState!==WebSocket.OPEN) return;
  const scale=canvas.width/LOGICAL_W;
  const offsetX=(canvas.width - LOGICAL_W*scale)/2;
  let logicalX=(clientX - offsetX);
  logicalX=Math.max(0, Math.min(LOGICAL_W-100, logicalX-50));
  ws.send(JSON.stringify({type:'paddle', player:playerId, x:logicalX}));
}

// کنترل موس و لمس
document.addEventListener('mousemove', e=>sendPaddle(e.clientX));
document.addEventListener('touchmove', e=>{ e.preventDefault(); sendPaddle(e.touches[0].clientX); }, {passive:false});

// رسم بازی
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(gameState){
    const scale=canvas.width/LOGICAL_W;
    const offsetX=(canvas.width - LOGICAL_W*scale)/2;
    const offsetY=(canvas.height - LOGICAL_H*scale)/2;

    // توپ با حرکت نرم
    renderBall.x += (gameState.ball.x - renderBall.x)*0.2;
    renderBall.y += (gameState.ball.y - renderBall.y)*0.2;
    ctx.fillStyle='white';
    ctx.beginPath();
    ctx.arc(offsetX + renderBall.x*scale, offsetY + renderBall.y*scale, Math.max(2, gameState.ball.radius*scale), 0, Math.PI*2);
    ctx.fill();

    // پدل‌ها با حرکت نرم
    gameState.paddles.forEach((p,i)=>{
      renderPaddles[i].x += (p.x - renderPaddles[i].x)*0.2;
      renderPaddles[i].y = p.y;
      ctx.fillRect(offsetX + renderPaddles[i].x*scale, offsetY + renderPaddles[i].y*scale, p.w*scale, p.h*scale);
    });
  }
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
