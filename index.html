<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PingPong Online - Lobby</title>
<style>
  html, body { margin:0; padding:0; height:100%; font-family:tahoma,Arial; background:#000; color:#fff; }
  #statusText { text-align:center; margin:10px; font-size:14px; }
  #lobbyCanvas { display:block; margin:0 auto; touch-action:none; background:#111; }
  #overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center;
    background:rgba(0,0,0,0.75); color:#fff; font-size:18px; text-align:center; z-index:10;
    flex-direction:column; display:none;
  }
  button { margin:6px; padding:8px 14px; font-size:14px; border-radius:6px; border:none; background:#222; color:#fff; }
</style>
</head>
<body>
<div id="statusText">در حال وصل شدن...</div>
<canvas id="lobbyCanvas" width="360" height="480"></canvas>
<div id="overlay">
  <div id="overlayText"></div>
  <button id="cancelRequestBtn" style="display:none">لغو درخواست</button>
  <button id="rematchBtn" style="display:none">بازی دوباره</button>
  <button id="acceptRematchBtn" style="display:none">قبول بازی دوباره</button>
</div>

<script>
const WS_URL = 'ws://localhost:8080'; // یا آدرس سرور واقعی
const canvas = document.getElementById('lobbyCanvas');
const ctx = canvas.getContext('2d');
const statusText = document.getElementById('statusText');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const cancelRequestBtn = document.getElementById('cancelRequestBtn');
const rematchBtn = document.getElementById('rematchBtn');
const acceptRematchBtn = document.getElementById('acceptRematchBtn');

const ROOM_COLS = 2;
const ROOM_ROWS = 5;
const ROOM_PADDING = 10;
const ROOM_W = 150;
const ROOM_H = 80;

let ws = null;
let clientId = null;
let rooms = [];
let currentRoom = null;
let inGame = false;

function showOverlay(yes) { overlay.style.display = yes ? 'flex' : 'none'; }

function connect() {
  if (ws) ws.close();
  ws = new WebSocket(WS_URL);
  ws.onopen = () => statusText.innerText = 'متصل شد';
  ws.onmessage = onMessage;
  ws.onclose = () => { statusText.innerText='در حال وصل شدن...'; setTimeout(connect,1000); };
}
connect();

function send(obj) {
  if (!ws || ws.readyState!==1) return;
  ws.send(JSON.stringify(obj));
}

// ================== lobby rendering ==================
function drawLobby() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  rooms.forEach((r,i)=>{
    let col = i%ROOM_COLS;
    let row = Math.floor(i/ROOM_COLS);
    let x = ROOM_PADDING + col*(ROOM_W+ROOM_PADDING);
    let y = ROOM_PADDING + row*(ROOM_H+ROOM_PADDING);
    // رنگ بر اساس وضعیت
    let color='#00f'; // خالی آبی
    if(r.status==='waiting') color='#f90'; // انتظار نارنجی
    if(r.status==='playing') color='#f00'; // بازی قرمز
    ctx.fillStyle=color;
    ctx.fillRect(x,y,ROOM_W,ROOM_H);
    ctx.fillStyle='#fff';
    ctx.font='9px Tahoma';
    ctx.textAlign='center';
    // متن روی اتاق
    let text='';
    if(r.status==='empty') text='اتاق خالی';
    if(r.status==='waiting') text=`در انتظار بازیکن دوم\n${r.names[0]||''}`;
    if(r.status==='playing') text=`در حال بازی\n${r.names[0]||''} ${r.scores[0]||0} - ${r.scores[1]||0} ${r.names[1]||''}`;
    let lines=text.split('\n');
    lines.forEach((line,j)=>{
      ctx.fillText(line,x+ROOM_W/2,y+15+12*j);
    });
  });
  requestAnimationFrame(drawLobby);
}
requestAnimationFrame(drawLobby);

canvas.addEventListener('click', e=>{
  if(inGame) return;
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;
  rooms.forEach((r,i)=>{
    let col = i%ROOM_COLS;
    let row = Math.floor(i/ROOM_COLS);
    let x = ROOM_PADDING + col*(ROOM_W+ROOM_PADDING);
    let y = ROOM_PADDING + row*(ROOM_H+ROOM_PADDING);
    if(mx>x && mx<x+ROOM_W && my>y && my<y+ROOM_H){
      if(r.status==='empty' || r.status==='waiting') {
        send({type:'requestRoom',roomId:i});
      }
    }
  });
});

// =================== overlay buttons ==================
cancelRequestBtn.onclick = ()=>{
  send({type:'cancelRequest'});
};
rematchBtn.onclick = ()=>{
  send({type:'rematchRequest'});
};
acceptRematchBtn.onclick = ()=>{
  send({type:'rematchAccept'});
};

// =================== handle server messages ==================
function onMessage(e){
  let data;
  try{data=JSON.parse(e.data);}catch{return;}
  const t=data.type;
  if(t==='assigned'){ clientId=data.clientId; statusText.innerText=`وضعیت: متصل (شناسه ${clientId})`; return;}
  if(t==='joined'){ statusText.innerText=`وضعیت: ${data.name} — آماده`; return;}
  if(t==='lobbySnapshot'){ rooms=data.rooms||[]; return;}
  if(t==='roomRequested'){ currentRoom=data.roomId; cancelRequestBtn.style.display='inline-block'; overlayText.innerText=`در صف اتاق ${currentRoom+1}`; showOverlay(true); return;}
  if(t==='requestCancelled'){ cancelRequestBtn.style.display='none'; overlayText.innerText='درخواست لغو شد'; setTimeout(()=>showOverlay(false),800); return;}
  if(t==='start'){ inGame=true; currentRoom=data.roomId; overlayText.innerText='بازی شروع شد'; showOverlay(false); return;}
  if(t==='gameover'){ inGame=false; overlayText.innerHTML=`بازی تمام شد<br/>نتیجه: ${data.scores[0]} - ${data.scores[1]}<br/>${data.winner===clientId?'شما برنده شدید':'حریف برنده شد'}`; rematchBtn.style.display='inline-block'; showOverlay(true); return;}
  if(t==='rematchRequested'){ overlayText.innerText='حریف درخواست بازی دوباره داده است'; acceptRematchBtn.style.display='inline-block'; rematchBtn.style.display='none'; showOverlay(true); return;}
  if(t==='rematchAccepted'){ overlayText.innerText='ری‌مچ پذیرفته شد'; acceptRematchBtn.style.display='none'; rematchBtn.style.display='none'; showOverlay(false); return;}
  if(t==='opponent_left'){ overlayText.innerText='حریف بازی را ترک کرد'; showOverlay(true); inGame=false; return;}
  if(t==='ping'){ send({type:'pong',ts:Date.now()}); return;}
}
</script>
</body>
</html>
