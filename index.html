<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بازی پینگ پنگ آنلاین</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .room {
      display: inline-block;
      width: 150px;
      height: 150px;
      margin: 10px;
      background-color: #2196F3;
      color: white;
      font-size: 12px;
      line-height: 150px;
      cursor: pointer;
      border-radius: 10px;
      position: relative;
    }
    .room.waiting {
      background-color: orange;
    }
    .room.playing {
      background-color: red;
    }
    #statusText {
      font-size: 18px;
      margin-top: 20px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      justify-content: center;
      align-items: center;
    }
    .overlay.show {
      display: flex;
    }
  </style>
</head>
<body>
  <h1>بازی پینگ پنگ آنلاین</h1>
  
  <!-- Section to display available rooms -->
  <div id="roomsContainer"></div>

  <!-- Status text -->
  <div id="statusText">وضعیت: در حال وصل شدن...</div>

  <!-- Overlay for game notifications -->
  <div id="overlay" class="overlay">
    <div id="overlayText"></div>
    <button id="rematchBtn" style="display:none;" onclick="requestRematch()">ری‌مچ</button>
    <button id="acceptRematchBtn" style="display:none;" onclick="acceptRematch()">پذیرفتن ری‌مچ</button>
    <button id="cancelRequestBtn" style="display:none;" onclick="cancelRoomRequest()">لغو درخواست</button>
    <button id="leaveBtn" style="display:none;" onclick="leaveRoom()">ترک اتاق</button>
  </div>

  <script>
    const ws = new WebSocket('wss://pingpong-te0t.onrender.com'); // Replace with your WebSocket URL
    let clientId = null;
    let playerName = '';
    let currentRoom = null;
    let inGame = false;

    // DOM Elements
    const statusText = document.getElementById('statusText');
    const roomsContainer = document.getElementById('roomsContainer');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const rematchBtn = document.getElementById('rematchBtn');
    const acceptRematchBtn = document.getElementById('acceptRematchBtn');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    const leaveBtn = document.getElementById('leaveBtn');

    // Handle incoming WebSocket messages
    ws.onmessage = function(e) {
      let data;
      try { data = JSON.parse(e.data); } catch { return; }
      const t = data.type;

      if (t === 'assigned') {
        clientId = data.clientId;
        statusText.innerText = `وضعیت: متصل (شناسه: ${clientId})`;
        return;
      }

      if (t === 'joined') {
        playerName = prompt('نام خود را وارد کنید:');
        ws.send(JSON.stringify({ type: 'setName', name: playerName }));
        statusText.innerText = `وضعیت: ${playerName} — آماده`;
        return;
      }

      if (t === 'lobbySnapshot') {
        // Update room tiles
        roomsContainer.innerHTML = ''; // Clear previous rooms
        (data.rooms || []).forEach(r => updateRoomTile(r));
        return;
      }

      if (t === 'roomRequested') {
        currentRoom = data.roomId;
        cancelRequestBtn.style.display = 'inline-block';
        leaveBtn.style.display = 'inline-block';
        overlayText.innerText = `شما در صف اتاق ${currentRoom + 1} هستید`;
        showOverlay(true);
        return;
      }

      if (t === 'requestCancelled') {
        cancelRequestBtn.style.display = 'none';
        overlayText.innerText = 'درخواست لغو شد';
        setTimeout(() => showOverlay(false), 800);
        return;
      }

      if (t === 'start') {
        inGame = true;
        overlayText.innerText = 'بازی شروع شد';
        showOverlay(false);
        rematchBtn.style.display = 'none';
        acceptRematchBtn.style.display = 'none';
        return;
      }

      if (t === 'gameover') {
        inGame = false;
        const winner = data.winner; // index
        const scores = data.scores || [0, 0];
        const meWon = winner === (currentRoom % 2); // Example win logic
        overlayText.innerHTML = `بازی تمام شد<br/>نتیجه: ${scores[0]} - ${scores[1]}<br/>${meWon ? 'تبریک، شما برنده‌اید' : 'بازیکن مقابل برنده شد'}`;
        rematchBtn.style.display = 'inline-block';
        acceptRematchBtn.style.display = 'none';
        showOverlay(true);
        return;
      }

      if (t === 'rematchRequested') {
        overlayText.innerText = 'حریف درخواست ری‌مچ داده است. قبول می‌کنید؟';
        acceptRematchBtn.style.display = 'inline-block';
        rematchBtn.style.display = 'none';
        showOverlay(true);
        return;
      }

      if (t === 'rematchAccepted') {
        overlayText.innerText = 'ری‌مچ پذیرفته شد — بازی در حال شروع';
        acceptRematchBtn.style.display = 'none';
        rematchBtn.style.display = 'none';
        setTimeout(() => showOverlay(false), 800);
        return;
      }

      if (t === 'opponent_left') {
        overlayText.innerText = 'حریف بازی را ترک کرد';
        rematchBtn.style.display = 'none';
        acceptRematchBtn.style.display = 'none';
        showOverlay(true);
        inGame = false;
        return;
      }
    };

    // Function to show overlay
    function showOverlay(show) {
      if (show) {
        overlay.classList.add('show');
      } else {
        overlay.classList.remove('show');
      }
    }

    // Function to update room tiles based on status
    function updateRoomTile(room) {
      const roomDiv = document.createElement('div');
      roomDiv.classList.add('room');
      roomDiv.classList.add(room.status);
      roomDiv.innerText = room.status === 'empty' ? 'اتاق خالی' : room.status === 'waiting' ? `اتاق در انتظار ${room.player1.name}` : `${room.player1.name} vs ${room.player2.name}\nامتیاز: ${room.scores[0]} - ${room.scores[1]}`;
      roomDiv.onclick = () => joinRoom(room.id);
      roomsContainer.appendChild(roomDiv);
    }

    // Function to join a room
    function joinRoom(roomId) {
      if (inGame) return; // Can't join room during a game
      ws.send(JSON.stringify({ type: 'requestRoom', roomId }));
    }

    // Function to cancel room request
    function cancelRoomRequest() {
      ws.send(JSON.stringify({ type: 'requestCancelled', roomId: currentRoom }));
    }

    // Function to leave room
    function leaveRoom() {
      ws.send(JSON.stringify({ type: 'leaveRoom', roomId: currentRoom }));
      showOverlay(false);
    }

    // Function to request a rematch
    function requestRematch() {
      ws.send(JSON.stringify({ type: 'rematchRequested', roomId: currentRoom }));
    }

    // Function to accept rematch
    function acceptRematch() {
      ws.send(JSON.stringify({ type: 'rematchAccepted', roomId: currentRoom }));
    }

    // Request lobby snapshot every 10 seconds if not received recently
    setInterval(() => {
      if (!inGame) {
        ws.send(JSON.stringify({ type: 'requestLobby' }));
      }
    }, 10000);
  </script>
</body>
</html>
