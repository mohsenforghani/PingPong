<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ping Pong آنلاین</title>
<style>
  body { margin:0; font-family:sans-serif; background:#f0f0f0; }
  #status { padding:10px; font-weight:bold; }
  #lobby { display:flex; flex-wrap:wrap; justify-content:center; margin-top:10px; }
  .room { width:90px; height:90px; margin:5px; display:flex; flex-direction:column; justify-content:center; align-items:center;
          font-size:9px; font-weight:bold; color:white; border-radius:5px; text-align:center; cursor:pointer; }
  .empty { background-color:blue; }
  .waiting { background-color:orange; }
  .playing { background-color:red; }
  #overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
             display:flex; justify-content:center; align-items:center; color:white; font-size:18px; text-align:center; display:none; flex-direction:column; }
  #overlay button { margin-top:10px; padding:5px 15px; font-size:16px; }
  canvas { display:block; margin:auto; background:#222; border:2px solid #333; }
</style>
</head>
<body>
<div id="status">وضعیت: در حال وصل شدن...</div>
<div id="lobby"></div>
<div id="overlay">
  <div id="overlayText"></div>
  <button id="cancelRequestBtn" style="display:none;">لغو درخواست</button>
  <button id="rematchBtn" style="display:none;">درخواست ری‌مچ</button>
  <button id="acceptRematchBtn" style="display:none;">قبول ری‌مچ</button>
</div>
<canvas id="gameCanvas" width="800" height="600" style="display:none;"></canvas>
<script>
const statusText = document.getElementById('status');
const lobbyDiv = document.getElementById('lobby');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const cancelRequestBtn = document.getElementById('cancelRequestBtn');
const rematchBtn = document.getElementById('rematchBtn');
const acceptRematchBtn = document.getElementById('acceptRematchBtn');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let ws;
let clientId = null;
let playerName = null;
let currentRoom = null;
let inGame = false;
let playerIndex = null;
let stateBuffer = [];
let gameState = null;
const MAX_STATE_BUFFER = 20;

function connect() {
  ws = new WebSocket('wss://pingpong-te0t.onrender.com');
  ws.onopen = () => statusText.innerText = 'وضعیت: متصل';
  ws.onmessage = onMessage;
  ws.onclose = () => {
    statusText.innerText = 'وضعیت: قطع شد، در حال تلاش برای اتصال مجدد...';
    setTimeout(connect, 3000);
  };
}

function send(obj) { if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(obj)); }

connect();

// دریافت نام بازیکن
function promptName() {
  playerName = prompt("نام خود را وارد کنید:");
  if (!playerName) playerName = `بازیکن${Math.floor(Math.random()*1000)}`;
  send({ type: 'setName', name: playerName });
}

function updateRoomTile(r) {
  let roomDiv = document.getElementById('room-'+r.id);
  if (!roomDiv) {
    roomDiv = document.createElement('div');
    roomDiv.id = 'room-'+r.id;
    roomDiv.className = 'room empty';
    roomDiv.addEventListener('click', ()=> requestRoom(r.id));
    lobbyDiv.appendChild(roomDiv);
  }

  if (r.status === 'empty') {
    roomDiv.className = 'room empty';
    roomDiv.innerHTML = 'اتاق خالی';
  } else if (r.status === 'waiting') {
    roomDiv.className = 'room waiting';
    roomDiv.innerHTML = `${r.player1.name}<br>در انتظار بازیکن دوم`;
  } else if (r.status === 'playing') {
    roomDiv.className = 'room playing';
    const s = r.scores || [0,0];
    roomDiv.innerHTML = `${r.player1.name} vs ${r.player2.name}<br>${s[0]} - ${s[1]}`;
  }
}

function requestRoom(roomId) {
  if (inGame) return;
  send({ type: 'requestRoom', roomId });
}
function onMessage(e) {
  let data;
  try { data = JSON.parse(e.data); } catch { return; }
  const t = data.type;

  if (t==='assigned') {
    clientId = data.clientId;
    promptName();
    return;
  }

  if (t==='joined') { statusText.innerText = `وضعیت: ${data.name} — آماده`; return; }

  if (t==='lobbySnapshot') { (data.rooms||[]).forEach(r=>updateRoomTile(r)); return; }

  if (t==='roomRequested') {
    currentRoom = data.roomId;
    cancelRequestBtn.style.display='inline-block';
    overlayText.innerText = `شما در صف اتاق ${currentRoom+1} هستید`;
    showOverlay(true);
    return;
  }

  if (t==='requestCancelled') {
    cancelRequestBtn.style.display='none';
    overlayText.innerText='درخواست لغو شد';
    setTimeout(()=>showOverlay(false),800);
    currentRoom = null;
    return;
  }

  if (t==='start') {
    inGame = true;
    playerIndex = data.playerIndex;
    currentRoom = data.roomId;
    overlayText.innerText='بازی شروع شد';
    showOverlay(false);
    stateBuffer=[];
    gameState=null;
    canvas.style.display='block';
    return;
  }

  if (t==='state') {
    const s = data.state;
    if(!s) return;
    stateBuffer.push({ ts: Date.now(), state: s });
    if(stateBuffer.length>MAX_STATE_BUFFER) stateBuffer.shift();
    gameState = s;
    return;
  }

  if (t==='gameover') {
    inGame=false;
    overlayText.innerHTML=`بازی تمام شد<br>نتیجه: ${data.scores[0]} - ${data.scores[1]}<br>${data.winner===playerIndex?'شما برنده شدید':'حریف برنده شد'}`;
    showOverlay(true);
    rematchBtn.style.display='inline-block';
    return;
  }

  if (t==='rematchRequested') {
    overlayText.innerText='حریف درخواست ری‌مچ داده است';
    acceptRematchBtn.style.display='inline-block';
    showOverlay(true);
    return;
  }

  if (t==='rematchAccepted') {
    overlayText.innerText='ری‌مچ پذیرفته شد — بازی در حال شروع';
    acceptRematchBtn.style.display='none';
    rematchBtn.style.display='none';
    showOverlay(false);
    return;
  }

  if (t==='opponent_left') {
    overlayText.innerText='حریف بازی را ترک کرد';
    showOverlay(true);
    inGame=false;
    canvas.style.display='none';
    return;
  }

  if (t==='ping') { send({ type:'pong', ts:Date.now() }); return; }
}

function showOverlay(yes) { overlay.style.display = yes?'flex':'none'; }

cancelRequestBtn.onclick = ()=>{ send({ type:'cancelRequest' }); };
rematchBtn.onclick = ()=>{ send({ type:'rematch' }); rematchBtn.style.display='none'; };
acceptRematchBtn.onclick = ()=>{ send({ type:'rematch' }); acceptRematchBtn.style.display='none'; };
// --- کنترل paddle ---
let mouseX = 0;
canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  mouseX = e.clientX - rect.left;
  if (inGame) send({ type:'paddle', x:mouseX });
});

// --- render loop ---
function render() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(gameState) {
    const b = gameState.ball;
    ctx.fillStyle='white';
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.r,0,2*Math.PI);
    ctx.fill();

    ctx.fillStyle='lime';
    gameState.paddles.forEach(p=>{
      ctx.fillRect(p.x,p.y,p.w,p.h);
    });
  }
  requestAnimationFrame(render);
}

render();

// --- lobby refresh fallback ---
setInterval(()=>send({ type:'requestLobby' }),10000);
</script>
</body>
</html>

