<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>PingPong آنلاین</title>
<style>
  :root { --btn-bg: #00ff88; --btn-color: #000; }
  html,body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:Tahoma, Arial, sans-serif; -webkit-user-select:none; user-select:none; }
  #gameCanvas { display:block; width:100%; height:100%; background:#000; touch-action:none; }
  .overlay { position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; display:flex; align-items:center; justify-content:center; }
  .ui-center { pointer-events:auto; text-align:center; }
  button { font-size:18px; padding:12px 18px; border-radius:10px; border:none; background:var(--btn-bg); color:var(--btn-color); cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.4); }
  #confirmBox { display:none; background:rgba(0,0,0,0.7); padding:16px; border-radius:12px; color:#fff; }
  .row { display:flex; gap:10px; justify-content:center; margin-top:8px; }
  #waitBtn { display:none; }
  #scoreBox { position:absolute; top:8px; left:0; right:0; text-align:center; pointer-events:none; font-weight:bold; }
  #statusText { position:absolute; bottom:10px; left:0; right:0; text-align:center; pointer-events:none; font-size:14px; color:#ddd; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="overlay">
  <div class="ui-center">
    <button id="waitBtn">در انتظار بازیکن...</button>

    <div id="confirmBox">
      <div style="font-size:18px; margin-bottom:8px;">بازیکن یک در انتظار شروع بازی است. آیا بازی می‌کنید؟</div>
      <div class="row">
        <button id="yesBtn">بله</button>
        <button id="noBtn">خیر</button>
      </div>
    </div>
  </div>
</div>

<div id="scoreBox"></div>
<div id="statusText"></div>

<script>
/* ====== تنظیمات ====== */
const WS_URL = 'wss://pingpong-te0t.onrender.com'; // URL سرور WebSocket
const LOGICAL_W = 450;
const LOGICAL_H = 800;

/* ====== عناصر UI ====== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const waitBtn = document.getElementById('waitBtn');
const confirmBox = document.getElementById('confirmBox');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const scoreBox = document.getElementById('scoreBox');
const statusText = document.getElementById('statusText');

/* ====== وضعیت محلی ====== */
let ws = null;
let playerId = null;
let waitingPlayerId = null;
let gameStarted = false;
let gameState = null;
let lastScores = null;
let lastSentXLogical = null;
const PADDLE_SEND_DELTA = 3;

let renderBall = { x: LOGICAL_W / 2, y: LOGICAL_H / 2 };
let renderPaddles = [
  { x: 0, y: 10 },
  { x: 0, y: LOGICAL_H - 30 }
];

/* ====== اندازه کانواس ====== */
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ====== WebSocket ====== */
function connectWS(){
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    statusText.textContent = 'متصل شد به سرور...';
    ws.send(JSON.stringify({ type: 'checkWaiting' }));
  };

  ws.onmessage = (evt) => {
    let data;
    try { data = JSON.parse(evt.data); } catch(e){ return; }

    switch(data.type) {
      case 'assign':
        playerId = data.playerId;
        waitBtn.style.display = 'block';
        break;
      case 'waiting_for_opponent':
        waitBtn.disabled = true;
        waitBtn.textContent = 'منتظر بازیکن دوم...';
        break;
      case 'opponent_waiting':
        confirmBox.style.display = 'block';
        waitBtn.style.display = 'none';
        break;
      case 'no_waiting':
        waitBtn.style.display = 'block';
        waitBtn.disabled = false;
        confirmBox.style.display = 'none';
        break;
      case 'declined':
        waitingPlayerId = null;
        waitBtn.style.display = 'block';
        waitBtn.disabled = false;
        confirmBox.style.display = 'none';
        break;
      case 'start':
        gameStarted = true;
        confirmBox.style.display = 'none';
        waitBtn.style.display = 'none';
        break;
      case 'state':
        gameState = data.state;
        if (!lastScores || lastScores[0] !== gameState.scores[0] || lastScores[1] !== gameState.scores[1]) {
          lastScores = [...gameState.scores];
          scoreBox.innerHTML = `<span style="font-size:24px">${gameState.scores[0]} - ${gameState.scores[1]}</span>`;
        }
        break;
      case 'full':
        alert('بازی پر است');
        break;
    }
  };

  ws.onclose = () => setTimeout(connectWS, 1000);
  ws.onerror = (err) => console.warn('WS error', err);
}
connectWS();

/* ====== UI دکمه‌ها ====== */
waitBtn.addEventListener('click', () => {
  if (!ws || ws.readyState !== WebSocket.OPEN || playerId === null) return;
  ws.send(JSON.stringify({ type: 'waitForPlayer' }));
  waitBtn.disabled = true;
  waitBtn.textContent = 'منتظر بازیکن دوم...';
});

yesBtn.addEventListener('click', () => {
  if (!ws || ws.readyState !== WebSocket.OPEN || playerId === null) return;
  ws.send(JSON.stringify({ type: 'acceptMatch' }));
  confirmBox.style.display = 'none';
});

noBtn.addEventListener('click', () => {
  if (!ws || ws.readyState !== WebSocket.OPEN || playerId === null) return;
  ws.send(JSON.stringify({ type: 'declineMatch' }));
  confirmBox.style.display = 'none';
});

/* ====== ارسال موقعیت پدل ====== */
let lastSent = 0;
const SEND_INTERVAL = 30;

function clientToLogicalX(clientX) {
  const scale = canvas.width / LOGICAL_W;
  const offsetX = (canvas.width - LOGICAL_W * scale) / 2;
  return (clientX - offsetX) / scale;
}

function sendPaddleXByClientX(clientX) {
  if (!ws || ws.readyState !== WebSocket.OPEN || playerId === null || !gameStarted) return;
  const now = Date.now();
  if (now - lastSent < SEND_INTERVAL) return;

  const paddleW = gameState ? gameState.paddles[playerId].w : 100;
  let logicalCenterX = clientToLogicalX(clientX);
  let left = logicalCenterX - paddleW / 2;
  left = Math.max(0, Math.min(LOGICAL_W - paddleW, left));
  if (lastSentXLogical !== null && Math.abs(lastSentXLogical - left) < PADDLE_SEND_DELTA) return;

  lastSent = now;
  lastSentXLogical = left;
  ws.send(JSON.stringify({ type: 'paddle', player: playerId, x: left }));
}

/* موس و لمس */
document.addEventListener('mousemove', e => { if(gameStarted) sendPaddleXByClientX(e.clientX); });
document.addEventListener('touchmove', e => { e.preventDefault(); if(gameStarted) sendPaddleXByClientX(e.touches[0].clientX); }, { passive:false });

/* ====== رسم بازی ====== */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const scale = canvas.width / LOGICAL_W;
  const offsetX = 0;
  const offsetY = 0;

  if(gameState){
    // توپ نرم
    renderBall.x += (gameState.ball.x - renderBall.x) * 0.2;
    renderBall.y += (gameState.ball.y - renderBall.y) * 0.2;

    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(offsetX + renderBall.x*scale, offsetY + renderBall.y*scale, Math.max(2, gameState.ball.radius*scale), 0, Math.PI*2);
    ctx.fill();

    // پدل‌ها
    ctx.fillStyle = 'white';
    gameState.paddles.forEach((p,i)=>{
      renderPaddles[i].x += (p.x - renderPaddles[i].x)*0.2;
      renderPaddles[i].y = p.y;
      ctx.fillRect(offsetX + renderPaddles[i].x*scale, offsetY + renderPaddles[i].y*scale, p.w*scale, p.h*scale);
    });

  } else {
    ctx.fillStyle = '#222';
    ctx.fillRect(canvas.width/2 - 80, canvas.height/2 - 6, 160, 12);
  }

  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);
</script>
</body>
</html>
