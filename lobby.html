<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ping Pong Lobby</title>
<style>
body { font-family: Tahoma, sans-serif; background: #f0f0f0; }
h1 { text-align: center; }
#status { text-align: center; margin-bottom: 10px; }
#rooms { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
.room {
    width: 90px; height: 90px; background: blue; color: white;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 9px; cursor: pointer; border-radius: 6px;
    text-align: center;
}
.room.waiting { background: orange; }
.room.playing { background: red; }
.room.finished { background: purple; }
</style>
</head>
<body>
<h1>لابی بازی Ping Pong</h1>
<div id="status">وضعیت: در حال وصل شدن...</div>
<div id="rooms"></div>

<script>
let ws;
let playerName = null;
let roomsData = [];
function connect() {
    ws = new WebSocket('wss://pingpong-te0t.onrender.com'); // آدرس سرور
    ws.onopen = () => { document.getElementById('status').innerText = 'وضعیت: متصل'; askName(); };
    ws.onmessage = onMessage;
    ws.onclose = () => setTimeout(connect, 2000);
}
function askName() {
    playerName = prompt("لطفاً نام خود را وارد کنید");
    if (!playerName) playerName = 'بازیکن';
    ws.send(JSON.stringify({ type:'setName', name: playerName }));
}
function onMessage(e) {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }
    if (data.type === 'lobbySnapshot') updateRooms(data.rooms);
}
function updateRooms(rooms) {
    roomsData = rooms;
    const container = document.getElementById('rooms');
    container.innerHTML = '';
    rooms.forEach(r => {
        const div = document.createElement('div');
        div.className = 'room ' + r.status;
        div.innerHTML = `
            ${r.status==='empty'?'اتاق خالی':
              r.status==='waiting'?'در انتظار بازیکن دوم':
              r.status==='playing'?'در حال بازی':'پایان'}
            <br>${r.player1||''} - ${r.player2||''}
            <br>${r.scores ? r.scores[0]+'-'+r.scores[1] : ''}
        `;
        div.onclick = () => requestRoom(r.id, r.status);
        container.appendChild(div);
    });
}
function requestRoom(roomId, status) {
    if (status==='empty' || status==='waiting') {
        ws.send(JSON.stringify({ type:'requestRoom', roomId }));
        alert('درخواست شما ثبت شد. وقتی بازی آماده شد، صفحه بازی باز می‌شود.');
        // باز شدن صفحه بازی بعد از start
        ws.onmessage = (e) => {
            let d;
            try { d=JSON.parse(e.data); } catch{return;}
            if (d.type==='start' && d.roomId===roomId) {
                window.location.href = `game.html?roomId=${roomId}&playerName=${playerName}`;
            }
        };
    }
}

connect();
</script>
</body>
</html>
