<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ping Pong Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #333;
            font-family: sans-serif;
            color: white;
            overflow: hidden;
        }

        canvas {
            display: block;
            background-color: #222;
        }

        .score {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            color: white;
            font-weight: bold;
        }

        .playerName {
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .player1Name {
            top: 20px;
            left: 20px;
            color: red;
        }

        .player2Name {
            bottom: 20px;
            left: 20px;
            color: blue;
        }

        .rematch-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #3498db;
            padding: 10px 20px;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div class="score">
    <span id="score1">0</span> - <span id="score2">0</span>
</div>
<div class="playerName player1Name" id="player1Name"></div>
<div class="playerName player2Name" id="player2Name"></div>

<button class="rematch-btn" id="rematchBtn">ری‌مچ</button>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const score1El = document.getElementById('score1');
    const score2El = document.getElementById('score2');
    const player1NameEl = document.getElementById('player1Name');
    const player2NameEl = document.getElementById('player2Name');
    const rematchBtn = document.getElementById('rematchBtn');

    let ws;
    let ball, paddle1, paddle2;
    let score1 = 0, score2 = 0;
    let player1Name = '', player2Name = '';
    let isGameOver = false;
    let currentRoomId = null;

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const GAME_W = canvas.width;
    const GAME_H = canvas.height;
    const PADDLE_WIDTH = 100;
    const PADDLE_HEIGHT = 20;
    const BALL_RADIUS = 15;
    const PADDLE_SPEED = 10;
    const BALL_SPEED = 5;

    function connectWS() {
        ws = new WebSocket(`wss://pingpong-te0t.onrender.com`);
        
        ws.onopen = () => { 
            console.log('Connected to server'); 
        };

        ws.onmessage = e => {
            const data = JSON.parse(e.data);

            switch(data.type) {
                case 'requestName':
                    if (!player1Name) {
                        const name = prompt(data.message);
                        player1Name = name;
                        ws.send(JSON.stringify({ type: 'setName', name: player1Name }));
                    }
                    break;
                case 'state':
                    updateGameState(data.state);
                    break;
                case 'gameover':
                    handleGameOver(data.scores, data.winner);
                    break;
                case 'rematchRequested':
                    if(confirm('آیا مایل به شروع دوباره بازی هستید؟')) {
                        ws.send(JSON.stringify({ type: 'rematch', roomId: currentRoomId }));
                    }
                    break;
                case 'rematchAccepted':
                    startNewGame();
                    break;
                case 'start':
                    currentRoomId = data.roomId;
                    startNewGame();
                    break;
            }
        };
    }

    function updateGameState(state) {
        ball = state.ball;
        paddle1 = state.paddles[0];
        paddle2 = state.paddles[1];

        score1 = state.scores[0];
        score2 = state.scores[1];

        player1Name = state.player1;
        player2Name = state.player2;

        renderGame();
    }

    function renderGame() {
        ctx.clearRect(0, 0, GAME_W, GAME_H);

        // Draw paddles
        ctx.fillStyle = 'red';
        ctx.fillRect(paddle1.x - PADDLE_WIDTH / 2, paddle1.y, PADDLE_WIDTH, PADDLE_HEIGHT);

        ctx.fillStyle = 'blue';
        ctx.fillRect(paddle2.x - PADDLE_WIDTH / 2, paddle2.y, PADDLE_WIDTH, PADDLE_HEIGHT);

        // Draw ball
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
        ctx.fill();

        // Draw score
        score1El.textContent = score1;
        score2El.textContent = score2;

        player1NameEl.textContent = player1Name;
        player2NameEl.textContent = player2Name;

        // اگر بازی تمام شده باشد
        if (isGameOver) {
            rematchBtn.style.display = 'block';
        } else {
            rematchBtn.style.display = 'none';
        }
    }

    function handleGameOver(scores, winner) {
        isGameOver = true;
        score1 = scores[0];
        score2 = scores[1];
        renderGame();
    }

    rematchBtn.addEventListener('click', () => {
        ws.send(JSON.stringify({ type: 'rematch', roomId: currentRoomId }));
        startNewGame();
    });

    function startNewGame() {
        score1 = 0;
        score2 = 0;
        isGameOver = false;
        rematchBtn.style.display = 'none';
        ws.send(JSON.stringify({ type: 'start', roomId: currentRoomId }));
    }

    // حرکت پدال‌ها با موس
    canvas.addEventListener('mousemove', (e) => {
        const x = e.clientX;
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'paddle', x: x }));
        }
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    connectWS();
</script>

</body>
</html>
