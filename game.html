<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ping Pong Game</title>
<style>
body { margin:0; background:#222; color:white; font-family:sans-serif; }
#topBar { text-align:center; padding:5px; background:#333; }
#canvasContainer { display:flex; justify-content:center; margin-top:10px; }
canvas { background:#000; border:2px solid #fff; }
#overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center;
    flex-direction: column; font-size:20px; display:none;
}
button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>
<div id="topBar">اتاق شماره: <span id="roomNumber"></span></div>
<div id="canvasContainer">
    <canvas id="gameCanvas" width="450" height="800"></canvas>
</div>
<div id="overlay">
    <div id="overlayText"></div>
    <div>
        <button id="rematchBtn">درخواست ری‌مچ</button>
        <button id="acceptRematchBtn">قبول ری‌مچ</button>
    </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const ROOM_ID = Number(urlParams.get('roomId')) || 0;
const PLAYER_NAME = urlParams.get('playerName') || 'بازیکن';
document.getElementById('roomNumber').innerText = ROOM_ID+1;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const rematchBtn = document.getElementById('rematchBtn');
const acceptRematchBtn = document.getElementById('acceptRematchBtn');

let ws, playerIndex = null, inGame=false, paddleX=200;
let ball = {x:225, y:400, r:15};
let paddles = [{x:200, y:20, w:100, h:20},{x:200, y:730, w:100, h:20}];
let scores = [0,0];

function connect() {
    ws = new WebSocket('wss://pingpong-te0t.onrender.com');
    ws.onopen = () => {
        ws.send(JSON.stringify({ type:'setName', name:PLAYER_NAME }));
        ws.send(JSON.stringify({ type:'requestRoom', roomId:ROOM_ID }));
    };
    ws.onmessage = onMessage;
    ws.onclose = () => setTimeout(connect,2000);
}
function onMessage(e) {
    let data; try { data=JSON.parse(e.data); } catch{return;}
    switch(data.type){
        case 'start':
            playerIndex = data.playerIndex;
            inGame=true;
            showOverlay(false);
            break;
        case 'state':
            ball = data.state.ball;
            paddles = data.state.paddles;
            scores = data.state.scores;
            break;
        case 'gameover':
            inGame=false;
            overlayText.innerHTML = `بازی تمام شد<br>نتیجه: ${data.scores[0]} - ${data.scores[1]}<br>` +
                (data.winner===playerIndex ? 'شما برنده شدید':'حریف برنده شد');
            showOverlay(true);
            break;
        case 'rematchRequested':
            overlayText.innerText = 'حریف درخواست ری‌مچ داده است. قبول می‌کنید؟';
            acceptRematchBtn.style.display='inline-block';
            rematchBtn.style.display='none';
            showOverlay(true);
            break;
        case 'rematchAccepted':
            overlayText.innerText='ری‌مچ پذیرفته شد — بازی شروع شد';
            showOverlay(false);
            break;
    }
}
function showOverlay(flag){overlay.style.display=flag?'flex':'none';}

rematchBtn.onclick=()=>{ws.send(JSON.stringify({type:'rematch'})); rematchBtn.style.display='none';};
acceptRematchBtn.onclick=()=>{ws.send(JSON.stringify({type:'acceptRematch'})); acceptRematchBtn.style.display='none';};

canvas.addEventListener('mousemove', e=>{
    const rect = canvas.getBoundingClientRect();
    paddleX = e.clientX - rect.left - paddles[playerIndex].w/2;
    ws.send(JSON.stringify({type:'paddle', x:paddleX}));
});

function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // توپ
    ctx.fillStyle='white';
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fill();

    // پدل‌ها
    ctx.fillStyle='cyan';
    ctx.fillRect(paddles[0].x, paddles[0].y, paddles[0].w, paddles[0].h);
    ctx.fillStyle='magenta';
    ctx.fillRect(paddles[1].x, paddles[1].y, paddles[1].w, paddles[1].h);

    // امتیاز
    ctx.fillStyle='white';
    ctx.font='20px Tahoma';
    ctx.fillText(`امتیاز: ${scores[0]} - ${scores[1]}`,10,30);

    requestAnimationFrame(gameLoop);
}

connect();
gameLoop();
</script>
</body>
</html>
